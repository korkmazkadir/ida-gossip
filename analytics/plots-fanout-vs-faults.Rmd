---
title: "IDA Gossip Experiment Results"
author: "Kadir Korkmaz"
date: "7/22/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Experimental Setup


\newpage

```{r first_chunk_delivery, echo=FALSE}
library(ggplot2)


mb_to_bytes<-1048576

#folder_path <- "/home/kadir/Desktop/ida-gossip/scripts/stats/"
folder_path <- "/home/kadir/Desktop/ida-gossip-experiments/fanout-vs-faults/"


### FaultyNodePercent GossipFanout
target_variable <- as.name("FaultyNodePercent")
x_label="Faults"


df_chunks <- read.csv(paste(folder_path, "first_chunk_delivery_df.tsv", sep = ""), sep = "\t", header = TRUE)
df_chunks$MessageSize = df_chunks$MessageSize / mb_to_bytes

p1 <- ggplot(df_chunks, aes(x= as.factor(!!target_variable), y=Median, group=MessageChunkCount, color=as.factor(MessageChunkCount), linetype=as.factor(MessageChunkCount), shape=as.factor(MessageChunkCount) )) +
      geom_line()+
      geom_point()+
      labs(x=x_label, y="First Chunk Delivery Time(ms)",  color='Chunk Count', shape='Chunk Count', linetype='Chunk Count') +
      expand_limits(y = 0) + 
      theme_bw() +
      theme(legend.position="top")
      
      #theme(legend.position = c(0.87, 0.25),
      #  legend.background = element_rect(fill = "white", color = "black"))



```


```{r message_delivery, echo=FALSE}

df_message_delivery <- read.csv(paste(folder_path, "message_received_df.tsv", sep = ""), sep = "\t", header = TRUE)
df_message_delivery$MessageSize = df_message_delivery$MessageSize / mb_to_bytes

p2 <- ggplot(df_message_delivery, aes(x= as.factor(!!target_variable), y=Median, group=MessageChunkCount, color=as.factor(MessageChunkCount), linetype=as.factor(MessageChunkCount), shape=as.factor(MessageChunkCount) )) +
      geom_line()+
      geom_point()+
      labs(x=x_label, y="Message Delivery Time(ms)",  color='Chunk Count', shape='Chunk Count', linetype='Chunk Count') +
      expand_limits(y = 0) +
      guides(color = "none", shape="none", linetype="none") +
      theme_bw() +
      theme(legend.position="top")


```



```{r delivered_messages, echo=FALSE}

df_delivery_percent <- data.frame(df_message_delivery) 

df_delivery_percent$DeliveryPercent <- (df_message_delivery$RowCount/df_message_delivery$ExperimentCount) * 100 / df_message_delivery$NodeCount


p3 <- ggplot(df_delivery_percent, aes(x= as.factor(!!target_variable), y=DeliveryPercent, group=MessageChunkCount, color=as.factor(MessageChunkCount), linetype=as.factor(MessageChunkCount), shape=as.factor(MessageChunkCount) )) +
      geom_line()+
      geom_point()+
      labs(x=x_label, y="Message Delivery Percent",  color='Chunk Count', shape='Chunk Count', linetype='Chunk Count') +
      expand_limits(y = 0) +
      guides(color = "none", shape="none", linetype="none")  +
      theme_bw() +
      theme(legend.position="top")



```


\newpage
```{r, echo=FALSE}
suppressPackageStartupMessages(library(dplyr))
library(knitr)

names(df_chunks)[names(df_chunks) == 'MessageChunkCount'] <- "ChunkCount"
names(df_message_delivery)[names(df_message_delivery) == 'MessageChunkCount'] <- "ChunkCount"
names(df_delivery_percent)[names(df_delivery_percent) == 'MessageChunkCount'] <- "ChunkCount"


```




\newpage
#```{r, echo=FALSE, fig.height=3, fig.width=4}
```{r, echo=FALSE, fig.height=5, fig.width=4}

#https://waterdata.usgs.gov/blog/beyond-basic-plotting/

df_chunks <- df_chunks %>% select( !!target_variable, GossipFanout, ChunkCount, Median) %>% rename( ChunkDelivery = Median)
df_message_delivery <- df_message_delivery  %>% select( !!target_variable, GossipFanout, ChunkCount, Median) %>% rename( MessageDelivery = Median)
df_delivery_percent <- df_delivery_percent  %>% select( !!target_variable, GossipFanout, ChunkCount, DeliveryPercent)

merged_df <- merge( df_chunks, df_message_delivery )
merged_df <- merge( merged_df, df_delivery_percent )

#merged_df <- df_delivery_percent

library(reshape)
melted_df <- melt(merged_df, id=c("FaultyNodePercent","GossipFanout","ChunkCount"))

kable(melted_df)

p <- ggplot(melted_df, aes(x= as.factor(!!target_variable), y=value, group=GossipFanout, color=as.factor(GossipFanout), linetype=as.factor(GossipFanout), shape=as.factor(GossipFanout) )) +
      geom_line()+
      geom_point()+
      #expand_limits(y = 0) +
      labs(color='Fanout', shape='Fanout', linetype='Fanout') +
      theme_bw()+
      theme(legend.position="top") +
      ylab(NULL) +
      xlab("Faulty Node Percent") +
      theme(strip.background = element_blank(), # remove the background
          strip.placement = "outside", legend.title=element_text(size=8), legend.margin=margin(0,-0,-6,0))

#, switch = "y"
p <- p + facet_grid(variable ~ ., scales = "free_y" , labeller = as_labeller(
      c(ChunkDelivery = "First Chunk Delivery, ms", MessageDelivery = "Message Delivery, ms", DeliveryPercent = "Delivery Percent"))
  ) + theme(plot.margin = margin(0,0,0,0, "cm")) #+ scale_y_continuous(labels = function(x) format(x, scientific = TRUE))

p

ggsave("faults_vs_fanout.pdf", p)


```


