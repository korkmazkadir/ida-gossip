---
title: "IDA Gossip Experiment Results"
author: "Kadir Korkmaz"
date: "7/22/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Experimental Setup
2048 process deployed on 16 machines---128 processes per machine---from G5K.
The bandwidth of each process is capped at 20Mbps(Upload Bandwidth). 
One-way latency of 15ms added to each communication link(RTT is 30ms).

In each experiment send concurrency of nodes changed to measure the effect of send consurrency on multichunk message dissemination.

\newpage

```{r first_chunk_delivery, echo=FALSE}
library(ggplot2)


mb_to_bytes<-1048576

folder_path <- "/home/kadir/Desktop/ida-gossip-send_parallel_5_round/"

target_variable <- as.name("ConcurrentSendCount")
x_label="ConcurrentSendCount"


df_chunks <- read.csv(paste(folder_path, "first_chunk_delivery_df.tsv", sep = ""), sep = "\t", header = TRUE)
df_chunks$MessageSize = df_chunks$MessageSize / mb_to_bytes

p1 <- ggplot(df_chunks, aes(x= as.factor(!!target_variable), y=Median, group=MessageChunkCount, color=as.factor(MessageChunkCount))) +
      geom_line()+
      geom_point()+
      labs(x=x_label, y="F. Chunk Delivery Time(ms)",  color='Chunk Count') +
      expand_limits(y = 0) + 
      theme(legend.position="top")



```


```{r message_delivery, echo=FALSE}

df_message_delivery <- read.csv(paste(folder_path, "message_received_df.tsv", sep = ""), sep = "\t", header = TRUE)
df_message_delivery$MessageSize = df_message_delivery$MessageSize / mb_to_bytes

p2 <- ggplot(df_message_delivery, aes(x= as.factor(!!target_variable), y=Median, group=MessageChunkCount, color=as.factor(MessageChunkCount) )) +
      geom_line()+
      geom_point()+
      labs(x=x_label, y="Mess. Delivery Time(ms)",  color='Chunk Count') +
      expand_limits(y = 0) +
      guides(color = "none")


```



```{r delivered_messages, echo=FALSE, fig.height=3}

df_delivery_percent <- data.frame(df_message_delivery) 

df_delivery_percent$DeliveryPercent <- (df_message_delivery$RowCount/5) * 100 / df_message_delivery$NodeCount


p3 <- ggplot(df_delivery_percent, aes(x= as.factor(!!target_variable), y=DeliveryPercent, group=MessageChunkCount, color=as.factor(MessageChunkCount) )) +
      geom_line()+
      geom_point()+
      labs(x=x_label, y="Percent of Message Delivery",  color='Chunk Count') +
      expand_limits(y = 0) +
      guides(color = "none")


```



```{r send_time, echo=FALSE}

df_send_time <- read.csv(paste(folder_path, "send_time_df.tsv", sep = ""), sep = "\t", header = TRUE)
df_send_time$MessageSize = df_send_time$MessageSize / mb_to_bytes

p4 <- ggplot(df_send_time, aes(x= as.factor(!!target_variable), y=Median, group=MessageChunkCount, color=as.factor(MessageChunkCount) )) +
      geom_line()+
      geom_point()+
      labs(x=x_label, y="Mean Chunk Send(ms)",  color='Chunk Count') +
      expand_limits(y = 0) +
      guides(color = "none")


```


```{r allign_plots, echo=FALSE, fig.height=9, fig.width=8}

library(gridExtra)

#p1 <- p1 + theme(axis.title.x = element_blank())
#p2 <- p2 + theme(axis.title.x = element_blank())
#p3 <- p3 + theme(axis.title.x = element_blank())

#plots <- list( p1, p2, p3, p4 )
plots <- list( p1, p2, p4 )
grobs <- list()
widths <- list()

for (i in 1:length(plots)){
    grobs[[i]] <- ggplotGrob(plots[[i]])
    widths[[i]] <- grobs[[i]]$widths[2:5]
}

maxwidth <- do.call(grid::unit.pmax, widths)

for (i in 1:length(grobs)){
     grobs[[i]]$widths[2:5] <- as.list(maxwidth)
}

do.call( "grid.arrange", c(grobs, ncol = 1) )

```


\newpage
```{r, echo=FALSE}
suppressPackageStartupMessages(library(dplyr))
library(knitr)

names(df_chunks)[names(df_chunks) == 'MessageChunkCount'] <- "ChunkCount"
names(df_message_delivery)[names(df_message_delivery) == 'MessageChunkCount'] <- "ChunkCount"
names(df_delivery_percent)[names(df_delivery_percent) == 'MessageChunkCount'] <- "ChunkCount"
names(df_send_time)[names(df_send_time) == 'MessageChunkCount'] <- "ChunkCount"


df_chunks <- df_chunks %>% select( !!target_variable, ChunkCount, Min, FirstQuartile, Median, ThirdQuartile, Max, Mean, RowCount) %>% arrange( !!target_variable, ChunkCount )
kable(df_chunks, caption = "First Chunk Delivery Time(ms)")

```

\newpage
```{r, echo=FALSE}

df_message_delivery <- df_message_delivery  %>% select( !!target_variable, ChunkCount,  Min, FirstQuartile, Median, ThirdQuartile, Max, Mean, RowCount) %>% arrange( !!target_variable, ChunkCount )
kable(df_message_delivery, caption = "Message Delivery Time(ms)")

```


\newpage

```{r, echo=FALSE}

df_delivery_percent <- df_delivery_percent  %>% select( !!target_variable, ChunkCount,  Min, FirstQuartile, Median, ThirdQuartile, Max, Mean, DeliveryPercent) %>% arrange( !!target_variable, ChunkCount )
kable(df_delivery_percent, caption = "Message Delivery Percent")

```

\newpage

```{r, echo=FALSE}


df_send_time <- df_send_time  %>% select( !!target_variable, ChunkCount,  Min, FirstQuartile, Median, ThirdQuartile, Max, Mean, RowCount) %>% arrange( !!target_variable, ChunkCount )
kable(df_send_time, caption = "Mean Chunk Send Time")

```



\newpage
```{r, echo=FALSE, fig.height=6, fig.width=4}

#https://waterdata.usgs.gov/blog/beyond-basic-plotting/

df_chunks <- df_chunks %>% select( !!target_variable, ChunkCount, Median) %>% rename( ChunkDelivery = Median)
df_message_delivery <- df_message_delivery  %>% select( !!target_variable, ChunkCount, Median) %>% rename( MessageDelivery = Median)
df_send_time <- df_send_time  %>% select( !!target_variable, ChunkCount, Median) %>% rename( SendTime = Median)

merged_df <- merge( df_chunks, df_message_delivery )
merged_df <- merge( merged_df, df_send_time )

library(reshape)
melted_df <- melt(merged_df, id=c("ConcurrentSendCount","ChunkCount"))

kable(melted_df)

p <- ggplot(melted_df, aes(x= as.factor(!!target_variable), y=value,  group=ChunkCount, color=as.factor(ChunkCount), linetype=as.factor(ChunkCount), shape=as.factor(ChunkCount) )) +
      geom_line()+
      geom_point()+
      expand_limits(y = 0) +
      labs(color='Chunk Count', shape='Chunk Count', linetype='Chunk Count') +
      theme_bw()+
      theme(legend.position="top") +
      ylab(NULL) +
      xlab("Concurrent Chunk Send Count") +
      theme(strip.background = element_blank(), # remove the background
          strip.placement = "outside", legend.title=element_text(size=8), legend.margin=margin(0,-0,-6,0))

#, switch = "y"
p <- p + facet_grid(variable ~ ., scales = "free_y" , labeller = as_labeller(
      c(ChunkDelivery = "First Chunk Delivery, ms", MessageDelivery = "Message Delivery, ms", SendTime = "Mean Chunk Send Time, ms"))
  ) + theme(plot.margin = margin(0,0,0,0, "cm")) #+ scale_y_continuous(labels = function(x) format(x, scientific = TRUE))

p

ggsave("chunk-scheduling.pdf", p)


```



